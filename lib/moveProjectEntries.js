'use strict';

var fsExtra = require('fs-extra'),
    necessary = require('necessary');

var constants = require('./constants'),
    pathMapsUtilities = require('./utilities/pathMaps');

var move = fsExtra.move,
    remove = fsExtra.remove,
    pathUtilities = necessary.pathUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    concatenatePaths = pathUtilities.concatenatePaths,
    asynchronousForEach = pathMapsUtilities.asynchronousForEach,
    DEST_ALREADY_EXISTS_MESSAGE = constants.DEST_ALREADY_EXISTS_MESSAGE,
    checkEntryExists = fileSystemUtilities.checkEntryExists,
    isEntryDirectory = fileSystemUtilities.isEntryDirectory,
    isDirectoryEmpty = fileSystemUtilities.isDirectoryEmpty;


function moveProjectEntries(projectsDirectoryPath, pathMaps, callback) {
  var targetPaths = [];

  asynchronousForEach(pathMaps, function (sourcePath, targetPath, directory, next, done, index) {
    moveEntry(sourcePath, targetPath, projectsDirectoryPath, function (targetPath) {
      targetPaths.push(targetPath);

      next();
    });
  }, function () {
    callback(targetPaths);
  });
}

module.exports = moveProjectEntries;

function moveEntry(sourcePath, targetPath, projectsDirectoryPath, callback) {
  if (targetPath === null) {
    callback(targetPath);
  } else {
    if (sourcePath === targetPath) {
      callback(targetPath);
    } else {
      var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
          entryExists = checkEntryExists(absoluteSourcePath);

      if (!entryExists) {
        targetPath = null;

        callback(targetPath);
      } else {
        var entryDirectory = isEntryDirectory(absoluteSourcePath);

        entryDirectory ? moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) : moveFile(sourcePath, targetPath, projectsDirectoryPath, callback);
      }
    }
  }
}

function moveFile(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = concatenatePaths(projectsDirectoryPath, targetPath);

  move(absoluteSourcePath, absoluteTargetPath, function (error) {
    var success = !error; ///

    targetPath = success ? targetPath : sourcePath;

    callback(targetPath);
  });
}

function moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = concatenatePaths(projectsDirectoryPath, targetPath),
      directoryEmpty = isDirectoryEmpty(absoluteSourcePath);

  if (!directoryEmpty) {
    var _targetPath = sourcePath;

    callback(_targetPath);
  } else {
    move(absoluteSourcePath, absoluteTargetPath, function (error) {
      var success = !error; ///

      if (success) {
        callback(targetPath);
      } else {
        var message = error.message;


        if (message !== DEST_ALREADY_EXISTS_MESSAGE) {
          var _targetPath2 = sourcePath;

          callback(_targetPath2);
        } else {
          remove(absoluteSourcePath, function (error) {
            var success = !error; ///

            if (!success) {
              targetPath = sourcePath;
            }

            callback(targetPath);
          });
        }
      }
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9tb3ZlUHJvamVjdEVudHJpZXMuanMiXSwibmFtZXMiOlsiZnNFeHRyYSIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJjb25zdGFudHMiLCJwYXRoTWFwc1V0aWxpdGllcyIsIm1vdmUiLCJyZW1vdmUiLCJwYXRoVXRpbGl0aWVzIiwiZmlsZVN5c3RlbVV0aWxpdGllcyIsImNvbmNhdGVuYXRlUGF0aHMiLCJhc3luY2hyb25vdXNGb3JFYWNoIiwiREVTVF9BTFJFQURZX0VYSVNUU19NRVNTQUdFIiwiY2hlY2tFbnRyeUV4aXN0cyIsImlzRW50cnlEaXJlY3RvcnkiLCJpc0RpcmVjdG9yeUVtcHR5IiwibW92ZVByb2plY3RFbnRyaWVzIiwicHJvamVjdHNEaXJlY3RvcnlQYXRoIiwicGF0aE1hcHMiLCJjYWxsYmFjayIsInRhcmdldFBhdGhzIiwic291cmNlUGF0aCIsInRhcmdldFBhdGgiLCJkaXJlY3RvcnkiLCJuZXh0IiwiZG9uZSIsImluZGV4IiwibW92ZUVudHJ5IiwicHVzaCIsIm1vZHVsZSIsImV4cG9ydHMiLCJhYnNvbHV0ZVNvdXJjZVBhdGgiLCJlbnRyeUV4aXN0cyIsImVudHJ5RGlyZWN0b3J5IiwibW92ZURpcmVjdG9yeSIsIm1vdmVGaWxlIiwiYWJzb2x1dGVUYXJnZXRQYXRoIiwiZXJyb3IiLCJzdWNjZXNzIiwiZGlyZWN0b3J5RW1wdHkiLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxVQUFVQyxRQUFRLFVBQVIsQ0FBaEI7QUFBQSxJQUNNQyxZQUFZRCxRQUFRLFdBQVIsQ0FEbEI7O0FBR0EsSUFBTUUsWUFBWUYsUUFBUSxhQUFSLENBQWxCO0FBQUEsSUFDTUcsb0JBQW9CSCxRQUFRLHNCQUFSLENBRDFCOztJQUdRSSxJLEdBQWlCTCxPLENBQWpCSyxJO0lBQU1DLE0sR0FBV04sTyxDQUFYTSxNO0lBQ05DLGEsR0FBdUNMLFMsQ0FBdkNLLGE7SUFBZUMsbUIsR0FBd0JOLFMsQ0FBeEJNLG1CO0lBQ2ZD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LE1BSU87QUFDTGhCLFNBQUt5QixrQkFBTCxFQUF5Qkssa0JBQXpCLEVBQTZDLFVBQVNDLEtBQVQsRUFBZ0I7QUFDM0QsVUFBTUMsVUFBVSxDQUFDRCxLQUFqQixDQUQyRCxDQUNuQzs7QUFFeEIsVUFBSUMsT0FBSixFQUFhO0FBQ1huQixpQkFBU0csVUFBVDtBQUNELE9BRkQsTUFFTztBQUFBLFlBQ0drQixPQURILEdBQ2VILEtBRGYsQ0FDR0csT0FESDs7O0FBR0wsWUFBSUEsWUFBWTVCLDJCQUFoQixFQUE2QztBQUMzQyxjQUFNVSxlQUFhRCxVQUFuQjs7QUFFQUYsbUJBQVNHLFlBQVQ7QUFDRCxTQUpELE1BSU87QUFDTGYsaUJBQU93QixrQkFBUCxFQUEyQixVQUFTTSxLQUFULEVBQWdCO0FBQ3pDLGdCQUFNQyxVQUFVLENBQUNELEtBQWpCLENBRHlDLENBQ2pCOztBQUV4QixnQkFBSSxDQUFDQyxPQUFMLEVBQWM7QUFDWmhCLDJCQUFhRCxVQUFiO0FBQ0Q7O0FBRURGLHFCQUFTRyxVQUFUO0FBQ0QsV0FSRDtBQVNEO0FBQ0Y7QUFDRixLQXhCRDtBQXlCRDtBQUNGIiwiZmlsZSI6Im1vdmVQcm9qZWN0RW50cmllcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgZnNFeHRyYSA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyksXG4gICAgICBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKSxcbiAgICAgIHBhdGhNYXBzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcGF0aE1hcHMnKTtcblxuY29uc3QgeyBtb3ZlLCByZW1vdmUgfSA9IGZzRXh0cmEsXG4gICAgICB7IHBhdGhVdGlsaXRpZXMsIGZpbGVTeXN0ZW1VdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgY29uY2F0ZW5hdGVQYXRocyB9ID0gcGF0aFV0aWxpdGllcyxcbiAgICAgIHsgYXN5bmNocm9ub3VzRm9yRWFjaCB9ID0gcGF0aE1hcHNVdGlsaXRpZXMsXG4gICAgICB7IERFU1RfQUxSRUFEWV9FWElTVFNfTUVTU0FHRSB9ID0gY29uc3RhbnRzLFxuICAgICAgeyBjaGVja0VudHJ5RXhpc3RzLCBpc0VudHJ5RGlyZWN0b3J5LCBpc0RpcmVjdG9yeUVtcHR5IH0gPSBmaWxlU3lzdGVtVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBtb3ZlUHJvamVjdEVudHJpZXMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBwYXRoTWFwcywgY2FsbGJhY2spIHtcbiAgY29uc3QgdGFyZ2V0UGF0aHMgPSBbXTtcblxuICBhc3luY2hyb25vdXNGb3JFYWNoKFxuICAgIHBhdGhNYXBzLFxuICAgIGZ1bmN0aW9uKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIGRpcmVjdG9yeSwgbmV4dCwgZG9uZSwgaW5kZXgpIHtcbiAgICAgIG1vdmVFbnRyeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGZ1bmN0aW9uKHRhcmdldFBhdGgpIHtcbiAgICAgICAgdGFyZ2V0UGF0aHMucHVzaCh0YXJnZXRQYXRoKTtcblxuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIGZ1bmN0aW9uKCkge1xuICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aHMpO1xuICAgIH1cbiAgKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBtb3ZlUHJvamVjdEVudHJpZXM7XG5cbmZ1bmN0aW9uIG1vdmVFbnRyeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGlmICh0YXJnZXRQYXRoID09PSBudWxsKSB7XG4gICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHNvdXJjZVBhdGggPT09IHRhcmdldFBhdGgpIHtcbiAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgc291cmNlUGF0aCksXG4gICAgICAgICAgICBlbnRyeUV4aXN0cyA9IGNoZWNrRW50cnlFeGlzdHMoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICAgICAgaWYgKCFlbnRyeUV4aXN0cykge1xuICAgICAgICB0YXJnZXRQYXRoID0gbnVsbDtcblxuICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGVudHJ5RGlyZWN0b3J5ID0gaXNFbnRyeURpcmVjdG9yeShhYnNvbHV0ZVNvdXJjZVBhdGgpO1xuXG4gICAgICAgIGVudHJ5RGlyZWN0b3J5ID9cbiAgICAgICAgICBtb3ZlRGlyZWN0b3J5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIDpcbiAgICAgICAgICAgIG1vdmVGaWxlKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBtb3ZlRmlsZShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgYWJzb2x1dGVUYXJnZXRQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHRhcmdldFBhdGgpO1xuXG4gIG1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBhYnNvbHV0ZVRhcmdldFBhdGgsIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgY29uc3Qgc3VjY2VzcyA9ICFlcnJvcjsgLy8vXG4gICAgXG4gICAgdGFyZ2V0UGF0aCA9IHN1Y2Nlc3MgP1xuICAgICAgICAgICAgICAgICAgIHRhcmdldFBhdGggOlxuICAgICAgICAgICAgICAgICAgICAgc291cmNlUGF0aDtcblxuICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbW92ZURpcmVjdG9yeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgYWJzb2x1dGVUYXJnZXRQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHRhcmdldFBhdGgpLFxuICAgICAgICBkaXJlY3RvcnlFbXB0eSA9IGlzRGlyZWN0b3J5RW1wdHkoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICBpZiAoIWRpcmVjdG9yeUVtcHR5KSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBtb3ZlKGFic29sdXRlU291cmNlUGF0aCwgYWJzb2x1dGVUYXJnZXRQYXRoLCBmdW5jdGlvbihlcnJvcikge1xuICAgICAgY29uc3Qgc3VjY2VzcyA9ICFlcnJvcjsgLy8vXG5cbiAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgeyBtZXNzYWdlIH0gPSBlcnJvcjtcblxuICAgICAgICBpZiAobWVzc2FnZSAhPT0gREVTVF9BTFJFQURZX0VYSVNUU19NRVNTQUdFKSB7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZW1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgY29uc3Qgc3VjY2VzcyA9ICFlcnJvcjsgLy8vXG5cbiAgICAgICAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAgICAgICB0YXJnZXRQYXRoID0gc291cmNlUGF0aDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19