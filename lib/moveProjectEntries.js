'use strict';

var fsExtra = require('fs-extra'),
    necessary = require('necessary');

var constants = require('./constants'),
    pathMapsUtilities = require('./utilities/pathMaps');

var move = fsExtra.move,
    remove = fsExtra.remove,
    pathUtilities = necessary.pathUtilities,
    fileSystemUtilities = necessary.fileSystemUtilities,
    concatenatePaths = pathUtilities.concatenatePaths,
    asynchronousForEach = pathMapsUtilities.asynchronousForEach,
    DEST_ALREADY_EXISTS_MESSAGE = constants.DEST_ALREADY_EXISTS_MESSAGE,
    checkEntryExists = fileSystemUtilities.checkEntryExists,
    isEntryDirectory = fileSystemUtilities.isEntryDirectory,
    isDirectoryEmpty = fileSystemUtilities.isDirectoryEmpty;


function moveProjectEntries(projectsDirectoryPath, json, callback) {
  var pathMaps = json.pathMaps,
      targetPaths = [];


  asynchronousForEach(pathMaps, function (sourcePath, targetPath, directory, next, done, index) {
    moveEntry(sourcePath, targetPath, projectsDirectoryPath, function (targetPath) {
      targetPaths.push(targetPath);

      next();
    });
  }, function () {
    var json = targetPaths; ///

    callback(json);
  });
}

module.exports = moveProjectEntries;

function moveEntry(sourcePath, targetPath, projectsDirectoryPath, callback) {
  if (targetPath === null) {
    callback(targetPath);
  } else {
    if (sourcePath === targetPath) {
      callback(targetPath);
    } else {
      var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
          entryExists = checkEntryExists(absoluteSourcePath);

      if (!entryExists) {
        targetPath = null;

        callback(targetPath);
      } else {
        var entryDirectory = isEntryDirectory(absoluteSourcePath);

        entryDirectory ? moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) : moveFile(sourcePath, targetPath, projectsDirectoryPath, callback);
      }
    }
  }
}

function moveFile(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = concatenatePaths(projectsDirectoryPath, targetPath);

  move(absoluteSourcePath, absoluteTargetPath, function (error) {
    var success = !error; ///

    targetPath = success ? targetPath : sourcePath;

    callback(targetPath);
  });
}

function moveDirectory(sourcePath, targetPath, projectsDirectoryPath, callback) {
  var absoluteSourcePath = concatenatePaths(projectsDirectoryPath, sourcePath),
      absoluteTargetPath = concatenatePaths(projectsDirectoryPath, targetPath),
      directoryEmpty = isDirectoryEmpty(absoluteSourcePath);

  if (!directoryEmpty) {
    var _targetPath = sourcePath;

    callback(_targetPath);
  } else {
    move(absoluteSourcePath, absoluteTargetPath, function (error) {
      var success = !error; ///

      if (success) {
        callback(targetPath);
      } else {
        var message = error.message;


        if (message !== DEST_ALREADY_EXISTS_MESSAGE) {
          var _targetPath2 = sourcePath;

          callback(_targetPath2);
        } else {
          remove(absoluteSourcePath, function (error) {
            var success = !error; ///

            if (!success) {
              targetPath = sourcePath;
            }

            callback(targetPath);
          });
        }
      }
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9tb3ZlUHJvamVjdEVudHJpZXMuanMiXSwibmFtZXMiOlsiZnNFeHRyYSIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJjb25zdGFudHMiLCJwYXRoTWFwc1V0aWxpdGllcyIsIm1vdmUiLCJyZW1vdmUiLCJwYXRoVXRpbGl0aWVzIiwiZmlsZVN5c3RlbVV0aWxpdGllcyIsImNvbmNhdGVuYXRlUGF0aHMiLCJhc3luY2hyb25vdXNGb3JFYWNoIiwiREVTVF9BTFJFQURZX0VYSVNUU19NRVNTQUdFIiwiY2hlY2tFbnRyeUV4aXN0cyIsImlzRW50cnlEaXJlY3RvcnkiLCJpc0RpcmVjdG9yeUVtcHR5IiwibW92ZVByb2plY3RFbnRyaWVzIiwicHJvamVjdHNEaXJlY3RvcnlQYXRoIiwianNvbiIsImNhbGxiYWNrIiwicGF0aE1hcHMiLCJ0YXJnZXRQYXRocyIsInNvdXJjZVBhdGgiLCJ0YXJnZXRQYXRoIiwiZGlyZWN0b3J5IiwibmV4dCIsImRvbmUiLCJpbmRleCIsIm1vdmVFbnRyeSIsInB1c2giLCJtb2R1bGUiLCJleHBvcnRzIiwiYWJzb2x1dGVTb3VyY2VQYXRoIiwiZW50cnlFeGlzdHMiLCJlbnRyeURpcmVjdG9yeSIsIm1vdmVEaXJlY3RvcnkiLCJtb3ZlRmlsZSIsImFic29sdXRlVGFyZ2V0UGF0aCIsImVycm9yIiwic3VjY2VzcyIsImRpcmVjdG9yeUVtcHR5IiwibWVzc2FnZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsVUFBVUMsUUFBUSxVQUFSLENBQWhCO0FBQUEsSUFDTUMsWUFBWUQsUUFBUSxXQUFSLENBRGxCOztBQUdBLElBQU1FLFlBQVlGLFFBQVEsYUFBUixDQUFsQjtBQUFBLElBQ01HLG9CQUFvQkgsUUFBUSxzQkFBUixDQUQxQjs7SUFHUUksSSxHQUFpQkwsTyxDQUFqQkssSTtJQUFNQyxNLEdBQVdOLE8sQ0FBWE0sTTtJQUNOQyxhLEdBQXVDTCxTLENBQXZDSyxhO0lBQWVDLG1CLEdBQXdCTixTLENBQXhCTSxt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QUZ2Qjs7QUFJQSxNQUFJLENBQUNRLGNBQUwsRUFBcUI7QUFDbkIsUUFBTWpCLGNBQWFELFVBQW5COztBQUVBSCxhQUFTSSxXQUFUO0FBQ0QsR0FKRCxNQUlPO0FBQ0xqQixTQUFLMEIsa0JBQUwsRUFBeUJLLGtCQUF6QixFQUE2QyxVQUFTQyxLQUFULEVBQWdCO0FBQzNELFVBQU1DLFVBQVUsQ0FBQ0QsS0FBakIsQ0FEMkQsQ0FDbkM7O0FBRXhCLFVBQUlDLE9BQUosRUFBYTtBQUNYcEIsaUJBQVNJLFVBQVQ7QUFDRCxPQUZELE1BRU87QUFBQSxZQUNHa0IsT0FESCxHQUNlSCxLQURmLENBQ0dHLE9BREg7OztBQUdMLFlBQUlBLFlBQVk3QiwyQkFBaEIsRUFBNkM7QUFDM0MsY0FBTVcsZUFBYUQsVUFBbkI7O0FBRUFILG1CQUFTSSxZQUFUO0FBQ0QsU0FKRCxNQUlPO0FBQ0xoQixpQkFBT3lCLGtCQUFQLEVBQTJCLFVBQVNNLEtBQVQsRUFBZ0I7QUFDekMsZ0JBQU1DLFVBQVUsQ0FBQ0QsS0FBakIsQ0FEeUMsQ0FDakI7O0FBRXhCLGdCQUFJLENBQUNDLE9BQUwsRUFBYztBQUNaaEIsMkJBQWFELFVBQWI7QUFDRDs7QUFFREgscUJBQVNJLFVBQVQ7QUFDRCxXQVJEO0FBU0Q7QUFDRjtBQUNGLEtBeEJEO0FBeUJEO0FBQ0YiLCJmaWxlIjoibW92ZVByb2plY3RFbnRyaWVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBmc0V4dHJhID0gcmVxdWlyZSgnZnMtZXh0cmEnKSxcbiAgICAgIG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpLFxuICAgICAgcGF0aE1hcHNVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9wYXRoTWFwcycpO1xuXG5jb25zdCB7IG1vdmUsIHJlbW92ZSB9ID0gZnNFeHRyYSxcbiAgICAgIHsgcGF0aFV0aWxpdGllcywgZmlsZVN5c3RlbVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBjb25jYXRlbmF0ZVBhdGhzIH0gPSBwYXRoVXRpbGl0aWVzLFxuICAgICAgeyBhc3luY2hyb25vdXNGb3JFYWNoIH0gPSBwYXRoTWFwc1V0aWxpdGllcyxcbiAgICAgIHsgREVTVF9BTFJFQURZX0VYSVNUU19NRVNTQUdFIH0gPSBjb25zdGFudHMsXG4gICAgICB7IGNoZWNrRW50cnlFeGlzdHMsIGlzRW50cnlEaXJlY3RvcnksIGlzRGlyZWN0b3J5RW1wdHkgfSA9IGZpbGVTeXN0ZW1VdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIG1vdmVQcm9qZWN0RW50cmllcyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGpzb24sIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHsgcGF0aE1hcHMgfSA9IGpzb24sXG5cdFx0ICAgIHRhcmdldFBhdGhzID0gW107XG5cbiAgYXN5bmNocm9ub3VzRm9yRWFjaChcbiAgICBwYXRoTWFwcyxcbiAgICBmdW5jdGlvbihzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBkaXJlY3RvcnksIG5leHQsIGRvbmUsIGluZGV4KSB7XG4gICAgICBtb3ZlRW50cnkoc291cmNlUGF0aCwgdGFyZ2V0UGF0aCwgcHJvamVjdHNEaXJlY3RvcnlQYXRoLCBmdW5jdGlvbih0YXJnZXRQYXRoKSB7XG4gICAgICAgIHRhcmdldFBhdGhzLnB1c2godGFyZ2V0UGF0aCk7XG5cbiAgICAgICAgbmV4dCgpO1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBmdW5jdGlvbigpIHtcbiAgICBcdGNvbnN0IGpzb24gPSB0YXJnZXRQYXRoczsgLy8vXG5cbiAgICAgIGNhbGxiYWNrKGpzb24pO1xuICAgIH1cbiAgKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBtb3ZlUHJvamVjdEVudHJpZXM7XG5cbmZ1bmN0aW9uIG1vdmVFbnRyeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGlmICh0YXJnZXRQYXRoID09PSBudWxsKSB7XG4gICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKHNvdXJjZVBhdGggPT09IHRhcmdldFBhdGgpIHtcbiAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBhYnNvbHV0ZVNvdXJjZVBhdGggPSBjb25jYXRlbmF0ZVBhdGhzKHByb2plY3RzRGlyZWN0b3J5UGF0aCwgc291cmNlUGF0aCksXG4gICAgICAgICAgICBlbnRyeUV4aXN0cyA9IGNoZWNrRW50cnlFeGlzdHMoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICAgICAgaWYgKCFlbnRyeUV4aXN0cykge1xuICAgICAgICB0YXJnZXRQYXRoID0gbnVsbDtcblxuICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGVudHJ5RGlyZWN0b3J5ID0gaXNFbnRyeURpcmVjdG9yeShhYnNvbHV0ZVNvdXJjZVBhdGgpO1xuXG4gICAgICAgIGVudHJ5RGlyZWN0b3J5ID9cbiAgICAgICAgICBtb3ZlRGlyZWN0b3J5KHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spIDpcbiAgICAgICAgICAgIG1vdmVGaWxlKHNvdXJjZVBhdGgsIHRhcmdldFBhdGgsIHByb2plY3RzRGlyZWN0b3J5UGF0aCwgY2FsbGJhY2spO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBtb3ZlRmlsZShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgYWJzb2x1dGVUYXJnZXRQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHRhcmdldFBhdGgpO1xuXG4gIG1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBhYnNvbHV0ZVRhcmdldFBhdGgsIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgY29uc3Qgc3VjY2VzcyA9ICFlcnJvcjsgLy8vXG4gICAgXG4gICAgdGFyZ2V0UGF0aCA9IHN1Y2Nlc3MgP1xuICAgICAgICAgICAgICAgICAgIHRhcmdldFBhdGggOlxuICAgICAgICAgICAgICAgICAgICAgc291cmNlUGF0aDtcblxuICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbW92ZURpcmVjdG9yeShzb3VyY2VQYXRoLCB0YXJnZXRQYXRoLCBwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IGFic29sdXRlU291cmNlUGF0aCA9IGNvbmNhdGVuYXRlUGF0aHMocHJvamVjdHNEaXJlY3RvcnlQYXRoLCBzb3VyY2VQYXRoKSxcbiAgICAgICAgYWJzb2x1dGVUYXJnZXRQYXRoID0gY29uY2F0ZW5hdGVQYXRocyhwcm9qZWN0c0RpcmVjdG9yeVBhdGgsIHRhcmdldFBhdGgpLFxuICAgICAgICBkaXJlY3RvcnlFbXB0eSA9IGlzRGlyZWN0b3J5RW1wdHkoYWJzb2x1dGVTb3VyY2VQYXRoKTtcblxuICBpZiAoIWRpcmVjdG9yeUVtcHR5KSB7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBtb3ZlKGFic29sdXRlU291cmNlUGF0aCwgYWJzb2x1dGVUYXJnZXRQYXRoLCBmdW5jdGlvbihlcnJvcikge1xuICAgICAgY29uc3Qgc3VjY2VzcyA9ICFlcnJvcjsgLy8vXG5cbiAgICAgIGlmIChzdWNjZXNzKSB7XG4gICAgICAgIGNhbGxiYWNrKHRhcmdldFBhdGgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgeyBtZXNzYWdlIH0gPSBlcnJvcjtcblxuICAgICAgICBpZiAobWVzc2FnZSAhPT0gREVTVF9BTFJFQURZX0VYSVNUU19NRVNTQUdFKSB7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0UGF0aCA9IHNvdXJjZVBhdGg7XG5cbiAgICAgICAgICBjYWxsYmFjayh0YXJnZXRQYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZW1vdmUoYWJzb2x1dGVTb3VyY2VQYXRoLCBmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgY29uc3Qgc3VjY2VzcyA9ICFlcnJvcjsgLy8vXG5cbiAgICAgICAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAgICAgICB0YXJnZXRQYXRoID0gc291cmNlUGF0aDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FsbGJhY2sodGFyZ2V0UGF0aCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19